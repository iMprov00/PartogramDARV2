<%# views/patients/show.erb - Партограмма пациентки %>
<div class="card card-modern fade-in-card">
  <div class="card-header-modern">
    <h5 class="card-title">
      <i class="bi bi-graph-up me-2"></i>Партограмма
    </h5>
  </div>
  
  <div class="card-body-modern">
    <!-- Информация о пациентке -->
    <div class="patient-info-partogram">
      <div class="patient-info-header">
        <div class="patient-main-info">
          <h4><%= @patient.full_name %></h4>
          <div class="text-muted">
            <% if @patient.age %><span><%= @patient.age %> лет</span><% end %>
            <% if @patient.gestational_age %> • <span><%= @patient.gestational_age %> недель</span><% end %>
          </div>
        </div>
        
        <div class="status-and-timer">
          <span class="badge status-badge-modern bg-<%= @patient.status_color %>">
            <%= @patient.status %>
          </span>
          <div class="timer-display-partogram" id="timer-display-container">
            <span class="timer-label">Период <%= @patient.period %></span>
            <span class="timer-value" id="timer-display">00:00:00</span>
          </div>
        </div>
      </div>
      
      <div class="patient-details-grid">
        <div class="patient-detail-item">
          <i class="bi bi-calendar"></i>
          <span>Поступление: <strong><%= @patient.admission_date.strftime('%d.%m.%Y') %></strong></span>
        </div>
        
        <% if @patient.history_number.present? %>
          <div class="patient-detail-item">
            <i class="bi bi-file-text"></i>
            <span>№ истории: <strong><%= @patient.history_number %></strong></span>
          </div>
        <% end %>
        
        <% if @patient.parity.present? %>
          <div class="patient-detail-item">
            <i class="bi bi-123"></i>
            <span>Партитет: <strong><%= @patient.parity %></strong></span>
          </div>
        <% end %>
        
        <% if @patient.labor_start.present? %>
          <div class="patient-detail-item">
            <i class="bi bi-clock-history"></i>
            <span>Начало родов: <strong><%= format_time(@patient.labor_start) %></strong></span>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Форма добавления измерения -->
    <div class="card card-modern mb-4">
      <div class="card-header-modern">
        <h6 class="card-title mb-0">
          <i class="bi bi-plus-circle me-2"></i>Новое измерение
        </h6>
      </div>
      <div class="card-body-modern">
        <form id="partogram-form">
          <!-- Время измерения -->
          <div class="partogram-form-section">
            <h6><i class="bi bi-clock me-1"></i> Время измерения</h6>
            <div class="time-control-group">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="use-current-time" checked>
                <label class="form-check-label" for="use-current-time">Текущее время</label>
              </div>
              <div class="time-input-group">
                <input type="datetime-local" 
                       class="form-control input-modern form-control-smaller" 
                       id="measurement-time" 
                       name="measurement_time"
                       disabled>
              </div>
            </div>
          </div>
          
          <!-- Основные показатели -->
          <div class="partogram-form-grid">
            <div class="partogram-form-section">
              <h6><i class="bi bi-heart-pulse me-1"></i> Состояние плода</h6>
              <div class="mb-3">
                <label for="fetal-heart-rate" class="form-label-modern">ЧСС плода</label>
                <input type="number" 
                       class="form-control input-modern form-control-smaller" 
                       id="fetal-heart-rate" 
                       name="fetal_heart_rate" 
                       min="60" 
                       max="200" 
                       placeholder="уд/мин">
              </div>
              <div class="mb-3">
                <label for="decelerations" class="form-label-modern">Децелерации</label>
                <select class="form-select input-modern form-control-smaller select-smaller" 
                        id="decelerations" 
                        name="decelerations">
                  <option value="">Нет</option>
                  <option value="ран">Ранние</option>
                  <option value="вар">Вариабельные</option>
                  <option value="поз">Поздние</option>
                </select>
              </div>
            </div>
            
            <div class="partogram-form-section">
              <h6><i class="bi bi-droplet me-1"></i> Околоплодные воды</h6>
              <div class="mb-3">
                <label for="amniotic-fluid" class="form-label-modern">Воды</label>
                <select class="form-select input-modern form-control-smaller select-smaller" 
                        id="amniotic-fluid" 
                        name="amniotic_fluid">
                  <option value="">—</option>
                  <option value="Ц">Целый пузырь</option>
                  <option value="С">Светлые</option>
                  <option value="М">С меконием</option>
                  <option value="К">С кровью</option>
                </select>
              </div>
            </div>
            
            <div class="partogram-form-section">
              <h6><i class="bi bi-person-badge me-1"></i> Положение</h6>
              <div class="mb-3">
                <label for="presentation" class="form-label-modern">Предлежание</label>
                <select class="form-select input-modern form-control-smaller select-smaller" 
                        id="presentation" 
                        name="presentation">
                  <option value="">—</option>
                  <option value="А">Передний вид</option>
                  <option value="Р">Задний вид</option>
                  <option value="Т">Поперечное</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Шейка матки и головка -->
          <div class="partogram-form-grid">
            <div class="partogram-form-section">
              <h6><i class="bi bi-circle me-1"></i> Шейка матки</h6>
              <div class="mb-3">
                <label for="cervical-dilation" class="form-label-modern">Раскрытие</label>
                <select class="form-select input-modern form-control-smaller select-smaller" 
                        id="cervical-dilation" 
                        name="cervical_dilation">
                  <option value="">—</option>
                  <% (0..10).each do |cm| %>
                    <option value="<%= cm %>"><%= cm %> см</option>
                  <% end %>
                </select>
                <small class="text-muted">10 см = 2 период</small>
              </div>
            </div>
            
            <div class="partogram-form-section">
              <h6><i class="bi bi-arrow-down me-1"></i> Головка</h6>
              <div class="mb-3">
                <label for="head-descent" class="form-label-modern">Опускание</label>
                <select class="form-select input-modern form-control-smaller select-smaller" 
                        id="head-descent" 
                        name="head_descent">
                  <option value="">—</option>
                  <option value="5">5 - над входом</option>
                  <option value="4">4 - 4/5 над лоном</option>
                  <option value="3">3 - 3/5 над лоном</option>
                  <option value="2">2 - 2/5 над лоном</option>
                  <option value="1">1 - 1/5 над лоном</option>
                  <option value="0">0 - не пальпируется</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Схватки -->
          <div class="partogram-form-section">
            <h6><i class="bi bi-activity me-1"></i> Схватки</h6>
            <div class="partogram-form-grid">
              <div>
                <label for="contraction-frequency" class="form-label-modern">Частота</label>
                <input type="number" 
                       class="form-control input-modern form-control-smaller" 
                       id="contraction-frequency" 
                       name="contraction_frequency" 
                       min="0" 
                       max="10" 
                       placeholder="в 10 мин">
              </div>
              
              <div>
                <label for="contraction-duration" class="form-label-modern">Длительность</label>
                <input type="number" 
                       class="form-control input-modern form-control-smaller" 
                       id="contraction-duration" 
                       name="contraction_duration" 
                       min="0" 
                       max="120" 
                       placeholder="секунд">
              </div>
              
              <div>
                <label for="pushing" class="form-label-modern">Потуги</label>
                <select class="form-select input-modern form-control-smaller select-smaller" 
                        id="pushing" 
                        name="pushing">
                  <option value="">—</option>
                  <option value="true">Да</option>
                  <option value="false">Нет</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Состояние матери -->
          <div class="partogram-form-section">
            <h6><i class="bi bi-person-heart me-1"></i> Состояние матери</h6>
            <div class="partogram-form-grid">
              <div>
                <label for="maternal-pulse" class="form-label-modern">Пульс</label>
                <input type="number" 
                       class="form-control input-modern form-control-smaller" 
                       id="maternal-pulse" 
                       name="maternal_pulse" 
                       min="40" 
                       max="180" 
                       placeholder="уд/мин">
              </div>
              
              <div>
                <label for="blood-pressure" class="form-label-modern">АД</label>
                <input type="text" 
                       class="form-control input-modern form-control-smaller" 
                       id="blood-pressure" 
                       name="blood_pressure" 
                       placeholder="120/80">
              </div>
              
              <div>
                <label for="temperature" class="form-label-modern">Температура</label>
                <input type="number" 
                       class="form-control input-modern form-control-smaller" 
                       id="temperature" 
                       name="temperature" 
                       step="0.1" 
                       min="35" 
                       max="42" 
                       placeholder="°C">
              </div>
            </div>
          </div>
          
          <!-- Кнопки формы -->
          <div class="form-actions-modern mt-4">
            <button type="submit" class="btn btn-primary" id="save-partogram-btn">
              <i class="bi bi-save me-2"></i>Сохранить измерение
            </button>
            <button type="button" 
                    class="btn btn-success" 
                    id="complete-labor-btn" 
                    <%= 'disabled' if @patient.status == 'роды завершены' %>>
              <i class="bi bi-check-circle me-2"></i>Завершить роды
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- История измерений -->
    <div class="card card-modern">
      <div class="card-header-modern">
        <h6 class="card-title mb-0">
          <i class="bi bi-clock-history me-2"></i>История измерений
        </h6>
      </div>
      <div class="card-body-modern">
        <div class="table-responsive">
          <table class="table table-modern partogram-table-modern" id="partogram-table">
            <thead>
              <tr>
                <th>Время</th>
                <th>ЧСС плода</th>
                <th>Децелерации</th>
                <th>Воды</th>
                <th>Раскрытие</th>
                <th>Схватки</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="partogram-tbody">
              <% @patient.partogram_entries.order(time: :desc).limit(15).each do |entry| %>
                <tr>
                  <td><%= format_time(entry.time) %></td>
                  <td><%= entry.fetal_heart_rate || '—' %></td>
                  <td>
                    <% if entry.decelerations %>
                      <span class="badge bg-<%= entry.decelerations == 'нет' ? 'secondary' : 'warning' %>">
                        <%= entry.decelerations %>
                      </span>
                    <% else %>
                      —
                    <% end %>
                  </td>
                  <td><%= entry.amniotic_fluid || '—' %></td>
                  <td>
                    <% if entry.cervical_dilation %>
                      <span class="badge <%= entry.cervical_dilation >= 10 ? 'bg-success' : 'bg-primary' %>">
                        <%= entry.cervical_dilation %> см
                      </span>
                    <% else %>
                      —
                    <% end %>
                  </td>
                  <td>
                    <% if entry.contraction_frequency %>
                      <small><%= entry.contraction_frequency %> в 10 мин</small>
                      <% if entry.contraction_duration %>
                        <br><small><%= entry.contraction_duration %> сек</small>
                      <% end %>
                      <% if entry.pushing == 'true' %>
                        <br><span class="badge bg-info">Потуги</span>
                      <% end %>
                    <% else %>
                      —
                    <% end %>
                  </td>
                  <td>
                    <button type="button" 
                            class="btn btn-sm btn-outline-danger delete-entry-btn" 
                            data-entry-id="<%= entry.id %>"
                            data-entry-time="<%= format_time(entry.time) %>"
                            data-entry-details="<%= "ЧСС: #{entry.fetal_heart_rate || '—'}, Раскрытие: #{entry.cervical_dilation || '—'} см" %>"
                            title="Удалить">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Кнопки навигации -->
    <div class="form-actions-modern mt-4">
      <a href="/patients" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Назад к списку
      </a>
      <a href="/patients/<%= @patient.id %>/edit" class="btn btn-outline-primary">
        <i class="bi bi-pencil me-1"></i>Редактировать
      </a>
    </div>
  </div>
</div>

<!-- Модальные окна (оставить без изменений) -->
<div class="modal fade" id="completeLaborModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Завершение родов</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Вы уверены, что хотите завершить роды для пациентки <strong><%= @patient.full_name %></strong>?</p>
        <p class="text-danger">После этого статус изменится на "роды завершены" и таймер остановится.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-success" id="confirm-complete-labor">Завершить роды</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteEntryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Удаление записи партограммы</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Вы уверены, что хотите удалить запись партограммы?</p>
        <p><strong>Время:</strong> <span id="entry-time-to-delete"></span></p>
        <p><strong>Данные:</strong> <span id="entry-details-to-delete"></span></p>
        <p class="text-danger">Это действие нельзя отменить.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-entry">Удалить</button>
      </div>
    </div>
  </div>
</div>

<script src="/js/partogram.js"></script>