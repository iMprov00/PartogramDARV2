<!-- views/patients/show.erb -->
<div class="card fade-in-card">
  <div class="card-header-modern">
    <h5 class="card-title">
      <i class="bi bi-graph-up me-2"></i>Партограмма пациентки
    </h5>
  </div>
  <div class="card-body-modern">
    <!-- Информация о пациентке -->
    <div class="patient-info-card mb-4">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h4><%= @patient.full_name %></h4>
          <div class="text-muted">
            <i class="bi bi-calendar me-1"></i>
            Дата поступления: <%= @patient.admission_date.strftime('%d.%m.%Y') %>
          </div>
        </div>
        <div class="col-md-6 text-md-end">
          <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-md-end gap-3">
            <span class="badge status-badge-modern bg-<%= @patient.status_color %> fs-6">
              <%= @patient.status %>
            </span>
            <div id="patient-timer" class="timer-display-large" data-patient-id="<%= @patient.id %>">
              <!-- Таймер будет вставлен через JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Таймер и текущий период -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-4 text-center">
            <div class="current-period-display">
              <div class="period-label">Текущий период</div>
              <div class="period-value" id="current-period">1</div>
              <div class="period-duration" id="timer-duration">30 мин</div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="timer-container">
              <div class="timer-circle">
                <svg class="progress-ring" width="200" height="200">
                  <circle class="progress-ring-circle" stroke="#e9ecef" stroke-width="8" fill="transparent" r="90" cx="100" cy="100"/>
                  <circle class="progress-ring-progress" stroke="#0d6efd" stroke-width="8" fill="transparent" r="90" cx="100" cy="100" stroke-dasharray="565.48" stroke-dashoffset="0"/>
                </svg>
                <div class="timer-text" id="timer-display">00:00</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Форма для измерений -->
    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-heart-pulse me-2"></i>Измерение ЧДД</h6>
      </div>
      <div class="card-body">
        <form id="measurement-form">
          <div class="row g-3 align-items-end">
            <div class="col-md-6">
              <label for="heart-rate" class="form-label">ЧДД (частота дыхательных движений)</label>
              <input type="number" 
                     class="form-control input-modern" 
                     id="heart-rate" 
                     name="heart_rate" 
                     min="1" 
                     max="300" 
                     required
                     placeholder="Введите ЧДД">
              <div class="form-text">При ЧДД > 120 начинается 2 период (15 мин)</div>
            </div>
            <div class="col-md-6">
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary flex-grow-1" id="save-measurement-btn">
                  <i class="bi bi-save me-2"></i>Сохранить измерение
                </button>
                <button type="button" class="btn btn-success" id="complete-labor-btn" <%= 'disabled' if @patient.status == 'роды завершены' %>>
                  <i class="bi bi-check-circle me-2"></i>Завершить роды
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <!-- История измерений -->

    <div class="card">
      <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>История измерений</h6>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-modern" id="measurements-table">
            <thead>
              <tr>
                <th>Время</th>
                <th>ЧДД</th>
                <th>Период</th>
                <th>Таймер</th>
              </tr>
            </thead>
            <tbody id="measurements-tbody">
              <% @patient.measurements.order(measured_at: :desc).limit(10).each do |measurement| %>
                <tr>
                  <td><%= format_time(measurement.measured_at) %></td>
                  <td><%= measurement.heart_rate %></td>
                  <td>
                    <span class="badge <%= measurement.period == 1 ? 'bg-info' : 'bg-warning' %>">
                      Период <%= measurement.period %>
                    </span>
                  </td>
                  <td><%= measurement.period == 1 ? '30 мин' : '15 мин' %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Кнопки навигации -->
    <div class="d-flex justify-content-between mt-4">
      <a href="/patients" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-1"></i> Назад к списку
      </a>
      <a href="/patients/<%= @patient.id %>/edit" class="btn btn-outline-secondary">
        <i class="bi bi-pencil me-1"></i> Редактировать
      </a>
    </div>
  </div>
</div>

<!-- Модальное окно для завершения родов -->
<div class="modal fade" id="completeLaborModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Завершение родов</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Вы уверены, что хотите завершить роды для пациентки <strong><%= @patient.full_name %></strong>?</p>
        <p class="text-danger">После этого статус изменится на "роды завершены" и таймер остановится.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-success" id="confirm-complete-labor">Завершить роды</button>
      </div>
    </div>
  </div>
</div>

<!-- Подключим скрипт партограммы -->
<script src="/js/partogram.js"></script>